<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plate Resort Control</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            height: 480px;
        }
        
        .main-container {
            padding: 8px;
            height: 480px;
            overflow-y: auto;
        }
        
        .control-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
        }
        
        .hotel-btn {
            width: 100%;
            height: 45px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid #ced4da;
            margin-bottom: 4px;
            background: white;
            color: #495057;
        }
        
        .hotel-btn:hover, .hotel-btn:active {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-1px);
        }
        
        .hotel-btn.btn-primary { background: #007bff; color: white; border-color: #007bff; }
        .hotel-btn.btn-success { background: #28a745; color: white; border-color: #28a745; }
        .hotel-btn.btn-info { background: #17a2b8; color: white; border-color: #17a2b8; }
        .hotel-btn.btn-warning { background: #ffc107; color: #212529; border-color: #ffc107; }
        
        .control-btn {
            height: 40px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.2s ease;
            border: 1px solid #dc3545;
            background: #dc3545;
            color: white;
        }
        
        .control-btn:hover, .control-btn:active {
            background: #c82333;
            border-color: #bd2130;
            transform: translateY(-1px);
        }
        
        .status-card {
            background: #495057;
            color: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .health-indicator {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 4px;
            text-align: center;
            color: #495057;
        }
        
        .health-value {
            font-size: 1.1em;
            font-weight: 600;
            margin: 2px 0;
        }
        
        .health-label {
            font-size: 0.75em;
            color: #6c757d;
        }
        
        .tab-content {
            background: transparent;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .nav-pills .nav-link {
            border-radius: 6px;
            font-weight: 500;
            margin: 0 2px;
            padding: 6px 12px;
            font-size: 0.9em;
            transition: all 0.2s ease;
            color: #495057;
            background: white;
            border: 1px solid #dee2e6;
        }
        
        .nav-pills .nav-link.active {
            background: #495057;
            color: white;
            border-color: #495057;
        }
        
        .hotel-display {
            font-size: 1.8em;
            font-weight: 600;
            color: #495057;
        }
        
        .debug-log {
            background: #212529;
            color: #28a745;
            border-radius: 4px;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #495057;
        }
        
        .header-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .section-title {
            font-size: 1em;
            font-weight: 500;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .container-fluid {
            padding: 4px;
        }
        
        .row {
            margin: 0;
        }
        
        .col, .col-md-6, .col-lg-3 {
            padding: 2px;
        }
        
        .btn {
            min-height: 40px;
            touch-action: manipulation;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #ced4da;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #adb5bd;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="control-card p-2">
            <!-- Clean Header -->
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="header-title">
                    Plate Resort Control
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-1" id="connectionStatus" style="font-size: 0.7em;">
                        Connected
                    </span>
                    <span class="text-muted" id="lastUpdate" style="font-size: 0.7em;">--:--</span>
                </div>
            </div>
            
            <!-- Clean Navigation Tabs -->
            <ul class="nav nav-pills mb-2" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="control-tab" data-bs-toggle="pill" data-bs-target="#control" type="button">
                        Control
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="status-tab" data-bs-toggle="pill" data-bs-target="#status" type="button">
                        Status
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="debug-tab" data-bs-toggle="pill" data-bs-target="#debug" type="button">
                        Debug
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="mainTabContent">
                <!-- Control Tab -->
                <div class="tab-pane fade show active" id="control" role="tabpanel">
                    <div class="row">
                        <div class="col-8">
                            <div class="section-title">
                                Hotel Positions
                            </div>
                            <div class="row g-1 mb-2">
                                <div class="col-6">
                                    <button class="btn btn-primary hotel-btn" onclick="executeCommand('hotel_A')">
                                        Hotel A
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-success hotel-btn" onclick="executeCommand('hotel_B')">
                                        Hotel B
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-info hotel-btn" onclick="executeCommand('hotel_C')">
                                        Hotel C
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-warning hotel-btn" onclick="executeCommand('hotel_D')">
                                        Hotel D
                                    </button>
                                </div>
                            </div>
                            
                            <div class="section-title">
                                Emergency Control
                            </div>
                            <div class="row g-1">
                                <div class="col-12">
                                    <button class="btn btn-danger control-btn w-100" onclick="executeCommand('emergency_stop')">
                                        Emergency Stop
                                    </button>
                                </div>
                            </div>
                            
                            <div class="section-title" style="margin-top: 1em;">
                                Connection Control
                            </div>
                            <div class="row g-1">
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary control-btn w-100" onclick="executeCommand('disconnect')">
                                        Disconnect
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-success control-btn w-100" onclick="executeCommand('reconnect')">
                                        Reconnect
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-4">
                            <div class="status-card text-center">
                                <div style="font-size: 0.8em; margin-bottom: 4px;">
                                    Active Hotel
                                </div>
                                <div class="hotel-display" id="currentHotel">--</div>
                                <div style="font-size: 0.75em; margin-top: 4px; opacity: 0.8;" id="statusText">Ready</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Tab -->
                <div class="tab-pane fade" id="status" role="tabpanel">
                    <div class="section-title">
                        Motor Health Monitor
                    </div>
                    <div class="row g-1">
                        <div class="col-6">
                            <div class="health-indicator">
                                <div class="health-value" id="temperature">--°C</div>
                                <div class="health-label">Temperature</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="health-indicator">
                                <div class="health-value" id="voltage">--V</div>
                                <div class="health-label">Voltage</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="health-indicator">
                                <div class="health-value" id="current">--mA</div>
                                <div class="health-label">Current</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="health-indicator">
                                <div class="health-value" id="load">--%</div>
                                <div class="health-label">Load</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Debug Tab -->
                <div class="tab-pane fade" id="debug" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="section-title mb-0">
                            Debug Console
                        </div>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearDebugLog()" style="font-size: 0.7em;">
                                Clear
                            </button>
                            <button class="btn btn-secondary btn-sm" id="debugToggle" onclick="toggleDebug()" style="font-size: 0.7em;">
                                Start Monitor
                            </button>
                        </div>
                    </div>
                    <div class="debug-log" id="debugLog">
                        <div>[System] Debug console ready</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Minimal Loading Indicator -->
    <div class="position-fixed top-50 start-50 translate-middle d-none" id="loadingOverlay" style="z-index: 9999;">
        <div class="bg-primary text-white p-2 rounded text-center" style="font-size: 0.8em;">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Processing...
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let debugInterval;
        let debugActive = false;
        
        // Execute motor command
        async function executeCommand(action) {
            showLoading(true);
            
            try {
                const response = await fetch('/api/move', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: action })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateHotelDisplay(result.position, null); // Will show "Moving" during transition
                    logDebug(`Command ${action} completed`);
                } else {
                    logDebug(`Command ${action} failed: ${result.error}`);
                }
            } catch (error) {
                logDebug(`Network error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        // Update hotel display
        function updateHotelDisplay(position, activeHotel) {
            const hotelElement = document.getElementById('currentHotel');
            const statusElement = document.getElementById('statusText');
            
            if (activeHotel) {
                hotelElement.textContent = activeHotel;
                statusElement.textContent = 'Active';
                statusElement.style.color = '#28a745';
            } else if (position < 5) {
                hotelElement.textContent = 'Home';
                statusElement.textContent = 'At Home';
                statusElement.style.color = '#007bff';
            } else {
                hotelElement.textContent = '--';
                statusElement.textContent = 'Moving';
                statusElement.style.color = '#ffc107';
            }
        }
        
        // Update health display
        function updateHealth(health) {
            document.getElementById('temperature').textContent = `${health.temperature}°C`;
            document.getElementById('voltage').textContent = `${health.voltage}V`;
            document.getElementById('current').textContent = `${health.current}mA`;
            document.getElementById('load').textContent = `${health.load}%`;
        }
        
        // Fetch status updates
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                updateHotelDisplay(data.position, data.active_hotel);
                updateHealth(data.health);
                
                const now = new Date();
                document.getElementById('lastUpdate').textContent = now.toLocaleTimeString().slice(0, 5);
                
                if (debugActive) {
                    logDebug(`Status: Hotel ${data.active_hotel || 'None'} | T:${data.health.temperature}°C | V:${data.health.voltage}V`);
                }
            } catch (error) {
                console.error('Status update failed:', error);
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                document.getElementById('connectionStatus').className = 'badge bg-danger me-1';
            }
        }
        
        // Toggle debug monitoring
        function toggleDebug() {
            const button = document.getElementById('debugToggle');
            
            if (debugActive) {
                debugActive = false;
                clearInterval(debugInterval);
                button.textContent = 'Start Monitor';
                button.className = 'btn btn-secondary btn-sm';
                logDebug('[System] Debug monitoring stopped');
            } else {
                debugActive = true;
                debugInterval = setInterval(updateStatus, 1000);
                button.textContent = 'Stop Monitor';
                button.className = 'btn btn-danger btn-sm';
                logDebug('[System] Debug monitoring started');
            }
        }
        
        // Clear debug log
        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '<div>[System] Log cleared</div>';
        }
        
        // Log debug message
        function logDebug(message) {
            const log = document.getElementById('debugLog');
            const now = new Date();
            const timestamp = now.toLocaleTimeString().slice(0, 8);
            
            const div = document.createElement('div');
            div.innerHTML = `[${timestamp}] ${message}`;
            
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            
            // Keep log size manageable
            const children = log.children;
            if (children.length > 50) {
                log.removeChild(children[0]);
            }
        }
        
        // Show/hide loading overlay
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('d-none');
            } else {
                overlay.classList.add('d-none');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus(); // Initial status update
            
            // Update status every 5 seconds
            setInterval(updateStatus, 5000);
            
            logDebug('[System] Interface ready');
        });
        
        // Touch event optimization for Pi touchscreen
        document.addEventListener('touchstart', function() {}, {passive: true});
    </script>
</body>
</html>
